//https://steamcommunity.com/sharedfiles/filedetails/?id=593226813

tileSize = 12
//18

mapa = [
  [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
  [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
  [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
  [2, 11,11,11,11,11,11,11,11,11,11,11,11,45,44,11,11,11,11,11,11,11,11,11,11,11,11,1],
  [4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,27,26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
  [4, 0,25,16,16,24, 0,25,16,16,16,24, 0,27,26, 0,25,16,16,16,24, 0,25,16,16,24, 0, 3],
  [4, 0,27,-1,-1,26, 0,27,-1,-1,-1,26, 0,27,26, 0,27,-1,-1,-1,26, 0,27,-1,-1,26, 0, 3],
  [4, 0,29,23,23,28, 0,29,23,23,23,28, 0,29,28, 0,29,23,23,23,28, 0,29,23,23,28, 0, 3],
  [4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
  [4, 0,25,16,16,24, 0,25,24, 0,25,16,16,16,16,16,16,24, 0,25,24, 0,25,16,16,24, 0, 3],
  [4, 0,29,23,23,28, 0,27,26, 0,29,23,23,37,36,23,23,28, 0,27,26, 0,29,23,23,28, 0, 3],
  [4, 0, 0, 0, 0, 0, 0,27,26, 0, 0, 0, 0,27,26, 0, 0, 0, 0,27,26, 0, 0, 0, 0, 0, 0, 3],
  [6,13,13,13,13,24, 0,27,38,16,16,24, 0,27,26, 0,25,16,16,39,26, 0,25,13,13,13,13, 5],
  [-1,-1,-1,-1,-1,4, 0,27,36,23,23,28,-1,29,28,-1,29,23,23,37,26, 0, 3,-1,-1,-1,-1,-1],
  [-1,-1,-1,-1,-1,4, 0,27,26,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,27,26, 0, 3,-1,-1,-1,-1,-1],
  [-1,-1,-1,-1,-1,4, 0,27,26,-1,31,13,35,50,50,34,13,30,-1,27,26, 0, 3,-1,-1,-1,-1,-1],
 [12,12,12,12,12,28, 0,29,28,-1, 3,-1,-1,-1,-1,-1,-1, 4,-1,29,28, 0,29,12,12,12,12,12],
  [-1,-1,-1,-1,-1,-1,0,-1,-1,-1, 3,-1,-1,-1,-1,-1,-1, 4,-1,-1,-1, 0,-1,-1,-1,-1,-1,-1],
 [13,13,13,13,13,24, 0,25,24,-1, 3,-1,-1,-1,-1,-1,-1, 4,-1,25,24, 0,25,13,13,13,13,13],
  [-1,-1,-1,-1,-1,4, 0,27,26,-1,33,12,12,12,12,12,12,32,-1,27,26, 0, 3,-1,-1,-1,-1,-1],
  [-1,-1,-1,-1,-1,4, 0,27,26,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,27,26, 0, 3,-1,-1,-1,-1,-1],
  [-1,-1,-1,-1,-1,4, 0,27,26,-1,25,16,16,16,16,16,16,24,-1,27,26, 0, 3,-1,-1,-1,-1,-1],
  [2,12,12,12,12,28, 0,29,28,-1,29,23,23,24,25,23,23,28,-1,29,28, 0,29,12,12,12,12, 1],
  [4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,27,26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
  [4, 0,25,16,16,24, 0,25,16,16,16,24, 0,27,26, 0,25,16,16,16,24, 0,25,16,16,24, 0, 3],
  [4, 0,29,23,37,26, 0,29,23,23,23,28, 0,29,28, 0,29,23,23,23,28, 0,27,36,23,28, 0, 3],
  [4, 0, 0, 0,27,26, 0, 0, 0, 0, 0, 0, 0,-1,-1, 0, 0, 0, 0, 0, 0, 0,27,26, 0, 0, 0, 3],
  [8,16,24, 0,27,26, 0,25,24, 0,25,16,16,16,16,16,16,24, 0,25,24, 0,27,26, 0,25,16, 7],
 [10,23,28, 0,29,28, 0,27,26, 0,29,23,23,37,36,23,23,28, 0,27,26, 0,29,28, 0,29,23, 9],
  [4, 0, 0, 0, 0, 0, 0,27,26, 0, 0, 0, 0,27,26, 0, 0, 0, 0,27,26, 0, 0, 0, 0, 0, 0, 3],
  [4, 0, 21,16,16,16,16,39,38,16,16,24,0,27,26, 0, 25,16,16,39,38,16,16,16,16,20,0, 3],
  [4, 0, 19,23,23,23,23,23,23,23,23,28,0,29,28, 0, 29,23,23,23,23,23,23,23,23,18,0, 3],
  [4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
  [6,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14, 5]
]

class Pacman {
  constructor(tileset){
    background(0);
    this.x = 13
    this.y = 26
    this.tileset = tileset
    this.uneatenPoints = 0
    this.level = 0
    this.direction = 'L'
    this.close = false
    this.score = 0
  }
  
  _indexTiles(i){
    let xTile = i%33
    let yTile = Math.floor(i/33)
    return {'x': xTile*tileSize+4, 'y':yTile*tileSize+5}
  }
  
  _drawTile(dx, dy, i){
    let {x, y} =  this._indexTiles(i)
    image(this.tileset, dx, dy, tileSize, tileSize, x, y, tileSize, tileSize);
  }
  
  drawMaze(){
    for (let alfa = 0; alfa<mapa.length; alfa++)
      for (let beta = 0; beta<mapa[alfa].length; beta++)
        if(mapa[alfa][beta]>0)
          this._drawTile(beta*tileSize, alfa*tileSize, mapa[alfa][beta]+213)
  }
  
  drawPoints(){
    for (let alfa = 0; alfa<mapa.length; alfa++)
      for (let beta = 0; beta<mapa[alfa].length; beta++)
        if(mapa[alfa][beta]==0)
          this._drawTile(beta*tileSize, alfa*tileSize, 16)
        else if(mapa[alfa][beta]==-1)
          this._drawTile(beta*tileSize, alfa*tileSize, 300)
          
  }
  
  newLevel(){
    this.drawMaze()
    this.uneatenPoints = 246
  }
  
  drawPacman(){
    this.close = !this.close
    let pac = {x: 4, y:198}  
    if (!this.close)
      if(this.direction == 'R')
        pac = {x:292, y:174}
      else if(this.direction == 'D')
        pac = {x:313, y:174}
      else if(this.direction == 'U')
        pac = {x:26, y:270}
      else
        pac = {x:4, y:270}
    image(this.tileset, 
          this.x*tileSize, //dx
          this.y*tileSize, //dy
          tileSize*1.6, 
          tileSize*1.5, 
          pac.x, //sx
          pac.y, //sy
          tileSize*2, 
          tileSize*2);
  }
  
  valid(x, y){
      return mapa[y][x]<1
  }
  
  setDirection(dir){
    const R = (dir == 'R' && this.valid(this.x+1, this.y))
    const D = (dir == 'D' && this.valid(this.x, this.y+1))
    const U = (dir == 'U' && this.valid(this.x, this.y-1))
    const L = (dir == 'L' && this.valid(this.x-1, this.y))
    if(R || D || U || L)
      this.direction = dir
  }
  
  move(){
    if(this.direction == 'R' && this.valid(this.x+1, this.y))
      if(this.x==25 && this.y==17)
        this.x=1
      else
        this.x++
    else if(this.direction == 'D' && this.valid(this.x, this.y+1))
      this.y++
    else if(this.direction == 'U' && this.valid(this.x, this.y-1))
      this.y--
    else if(this.direction == 'L' && this.valid(this.x-1, this.y))
      if(this.x==1 && this.y==17)
        this.x=25
      else
        this.x--
    if(mapa[this.y][this.x]==0){
      mapa[this.y][this.x]=-1
      this.score++
    }
  }

  update(){
    if(this.uneatenPoints==0)
      this.newLevel()
    this.move()
  }
  
  draw(){
    this.update()
    this.drawMaze()
    this.drawPoints()
    this.drawPacman()
  }
}